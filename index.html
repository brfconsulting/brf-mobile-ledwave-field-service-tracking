<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Service Tracking</title>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  background:#0f172a;
  font-family:Inter,sans-serif;
}

#map { height:100%; width:100%; }

.panel {
  position:absolute;
  top:20px;
  right:20px;
  background:#111827;
  color:white;
  padding:16px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
  z-index:999;
  font-size:13px;
  line-height:1.6;
  width:260px;
}

.legend {
  position:absolute;
  bottom:20px;
  right:20px;
  background:#111827;
  color:white;
  padding:14px;
  border-radius:12px;
  font-size:12px;
  z-index:999;
}

.legend div { margin-bottom:6px; }

.slider-container {
  position:absolute;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  width:60%;
  z-index:999;
  text-align:center;
}

#currentTime {
  margin-bottom:8px;
  background:rgba(0,0,0,0.75);
  padding:6px 10px;
  border-radius:8px;
  font-size:13px;
  font-weight:500;
  color:#ffffff;
  display:inline-block;
}

.controls {
  position:absolute;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  z-index:999;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
}

button, select {
  background:#4f46e5;
  color:white;
  border:none;
  padding:8px 18px;
  border-radius:6px;
  cursor:pointer;
}

.badge {
  position:absolute;
  top:20px;
  left:20px;
  background:#4f46e5;
  color:white;
  padding:8px 12px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
  z-index:999;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel" id="infoPanel"></div>

<!-- NOVO CARD (mesmo padrão visual) -->
<div class="panel" id="servicePanel" style="top:200px; right:20px;">
  <strong>Informações do Serviço</strong><br/>
  Carregando...
</div>

<div class="legend">
  <strong>Legenda</strong><br/>
  <div><span style="color:#22d3ee;">●</span> Ponto Azul → Atual</div>
  <div><span style="color:#22c55e;">●</span> Ponto Verde → Início</div>
  <div><span style="color:#ef4444;">●</span> Ponto Vermelho → Fim</div>
  <div><span style="color:#3b82f6;">■</span> Trecho Azul → Próximo do início</div>
  <div><span style="color:#8b5cf6;">■</span> Trecho Roxo → Meio do percurso</div>
  <div><span style="color:#ef4444;">■</span> Trecho Vermelho → Próximo do fim</div>
</div>

<div class="badge" id="envBadge"></div>

<div class="slider-container">
  <div id="currentTime"></div>
  <input type="range" id="timeline" min="0" max="0" value="0" style="width:100%;">
</div>

<div class="controls">
  <button id="goStartBtn">Início</button>
  <button id="playBtn">Play</button>
  <button id="pauseBtn">Pausar</button>
  <button id="goEndBtn">Fim</button>

  <select id="speedControl">
    <option value="1">1x</option>
    <option value="1.5">1.5x</option>
    <option value="2">2x</option>
    <option value="2.5">2.5x</option>
    <option value="3">3x</option>
  </select>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const ENVIRONMENTS={
  qa:"https://field-service-dev-e78fc3d6d358.herokuapp.com",
  prod:"https://field-service-c770e658da59.herokuapp.com"
};

const map=L.map('map');

const light=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const dark=L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');

light.addTo(map);

L.control.layers(
  { "Light": light, "Dark": dark },
  null,
  { position: "bottomleft" }
).addTo(map);

function getQueryParams(){
  const p=new URLSearchParams(window.location.search);
  return { serviceId:p.get("serviceId"), env:p.get("env") };
}

function calculateDistance(points){
  let total=0;
  for(let i=1;i<points.length;i++){
    total+=map.distance(points[i-1],points[i]);
  }
  return total/1000;
}

function formatDateTime(dateStr){
  const d=new Date(dateStr);
  return d.toLocaleString("pt-BR",{
    dateStyle:"full",
    timeStyle:"medium"
  });
}

function interpolateColor(ratio){
  if(ratio<0.5){
    const t=ratio/0.5;
    return `rgb(${59+((139-59)*t)},${130+((92-130)*t)},246)`;
  } else {
    const t=(ratio-0.5)/0.5;
    return `rgb(${139+((239-139)*t)},${92+((68-92)*t)},${246-((246-68)*t)})`;
  }
}

async function loadServiceInfo(apiBase, serviceId){
  try{
    const res=await fetch(`${apiBase}/salesforce/get-servico-by-id/${serviceId}`);
    if(!res.ok) throw new Error("Serviço não encontrado");

    const s=await res.json();

    document.getElementById("servicePanel").innerHTML=`
      <strong>Informações do Serviço</strong><br/>
      <b>Nome:</b> ${s.nome}<br/>
      <b>Status:</b> ${s.status}<br/>
      <b>Início:</b> ${formatDateTime(s.dataHoraInicio)}<br/>
      <b>Fim:</b> ${formatDateTime(s.dataHoraFim)}<br/>
      <b>Descrição:</b> ${s.descricao}
    `;
  }catch(error){
    console.error("Erro ao carregar serviço:",error);
  }
}

async function loadTracking(apiBase,serviceId){
  try{
    const res=await fetch(`${apiBase}/salesforce/service-track/${serviceId}`);
    const result=await res.json();

    if(!result?.data?.track?.length){
      throw new Error("Track inválido ou vazio");
    }

    const track=result.data.track;
    const latlngs=track.map(p=>[p.latitude,p.longitude]);
    document.getElementById("timeline").max=latlngs.length-1;

    const glowLine=L.polyline(latlngs,{
      color:"#ffffff",
      weight:14,
      opacity:0.15
    }).addTo(map);

    const segments=[];
    for(let i=1;i<latlngs.length;i++){
      const ratio=i/latlngs.length;
      const color=interpolateColor(ratio);
      const seg=L.polyline([latlngs[i-1],latlngs[i]],{
        color,
        weight:6,
        opacity:0.85
      }).addTo(map);
      segments.push(seg);
    }

    map.fitBounds(glowLine.getBounds());

    L.circleMarker(latlngs[0],{
      radius:10,
      color:"#ffffff",
      weight:2,
      fillColor:"#22c55e",
      fillOpacity:1
    }).addTo(map)
      .bindTooltip("Início",{permanent:true,direction:"top",offset:[0,-18]});

    L.circleMarker(latlngs[latlngs.length-1],{
      radius:10,
      color:"#ffffff",
      weight:2,
      fillColor:"#ef4444",
      fillOpacity:1
    }).addTo(map)
      .bindTooltip("Fim",{permanent:true,direction:"top",offset:[0,-18]});

    const movingMarker=L.circleMarker(latlngs[0],{
      radius:8,
      color:"#ffffff",
      weight:2,
      fillColor:"#22d3ee",
      fillOpacity:1
    }).addTo(map);

    let index=0;
    let playing=false;
    let baseSpeed=600;

    function updateUI(){
      movingMarker.setLatLng(latlngs[index]);
      document.getElementById("timeline").value=index;

      const formatted=formatDateTime(track[index].dateTime);
      document.getElementById("currentTime").innerText=formatted;

      movingMarker.bindTooltip(formatted,{
        permanent:true,
        direction:"top",
        offset:[0,-18]
      }).openTooltip();

      segments.forEach((s,i)=>{
        s.setStyle({ opacity: i<index?1:0.45 });
      });
    }

    function step(){
      if(!playing) return;
      if(index>=latlngs.length-1){
        playing=false;
        document.getElementById("playBtn").innerText="Play";
        return;
      }
      index++;
      updateUI();
      const multiplier=parseFloat(document.getElementById("speedControl").value);
      setTimeout(step, baseSpeed/multiplier);
    }

    document.getElementById("playBtn").addEventListener("click",()=>{
      playing=!playing;
      document.getElementById("playBtn").innerText=playing?"Pause":"Play";
      if(playing) step();
    });

    document.getElementById("pauseBtn").addEventListener("click",()=>{
      playing=false;
      document.getElementById("playBtn").innerText="Play";
    });

    document.getElementById("goStartBtn").addEventListener("click",()=>{
      index=0;
      updateUI();
    });

    document.getElementById("goEndBtn").addEventListener("click",()=>{
      index=latlngs.length-1;
      updateUI();
    });

    document.getElementById("timeline").addEventListener("input",e=>{
      index=parseInt(e.target.value);
      updateUI();
    });

    updateUI();

    const distance=calculateDistance(latlngs);
    const hours=(latlngs.length/60).toFixed(2);

    document.getElementById("infoPanel").innerHTML=`
      <strong>Resumo do Percurso</strong><br/>
      Pontos coletados: ${latlngs.length}<br/>
      Duração: ${hours}h<br/>
      Distância: ${distance.toFixed(2)} km
    `;

  }catch(error){
    console.error("Erro ao carregar tracking:",error);
    alert("Erro ao carregar percurso do técnico.");
  }
}

const {serviceId,env}=getQueryParams();

if(!serviceId) throw new Error("Missing serviceId");
if(!env||!ENVIRONMENTS[env]) throw new Error("Invalid env");

document.getElementById("envBadge").innerText=env.toUpperCase();

loadTracking(ENVIRONMENTS[env],serviceId);
loadServiceInfo(ENVIRONMENTS[env],serviceId);
</script>
</body>
</html>